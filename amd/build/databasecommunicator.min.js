define("block_revisionmanager/databasecommunicator",["jquery","core/ajax","core/notification"],(function($,Ajax,Notification){return{init:function(params){const grid=document.getElementById("rating-grid"),plusBtn=document.getElementById("plusBtn"),popup=document.getElementById("rating-popup"),dateInput=document.getElementById("rating-date"),valueInput=document.getElementById("rating-value"),saveBtn=document.getElementById("rating-save"),pageurl=window.location.pathname+window.location.search;let editingDiv=null;function openPopup(x,y){let rating=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",date=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";popup.style.position="absolute",popup.style.left="".concat(x,"px"),popup.style.top="".concat(y,"px"),popup.style.display="block",valueInput.value=rating,dateInput.value=date}function createRatingSquare(rating,date,uniqueKey){const div=document.createElement("div");return div.className="rating-square bg-rating-".concat(rating),div.textContent=rating,div.title="Date: ".concat(date),div.dataset.rating=rating,div.dataset.date=date,div.dataset.key=uniqueKey,div.addEventListener("click",(function(e){editingDiv=div;const rect=div.getBoundingClientRect(),containerRect=grid.getBoundingClientRect();openPopup(rect.left-containerRect.left+grid.scrollLeft,rect.top-containerRect.top+45,div.dataset.rating,div.dataset.date),e.stopPropagation()})),div}null==plusBtn||plusBtn.addEventListener("click",(e=>{editingDiv=null;const rect=plusBtn.getBoundingClientRect(),containerRect=grid.getBoundingClientRect();openPopup(rect.left-containerRect.left+grid.scrollLeft,rect.top-containerRect.top+45,"",(new Date).toISOString().split("T")[0]),e.stopPropagation()})),null==saveBtn||saveBtn.addEventListener("click",(function(){var _editingDiv,_editingDiv$dataset;const rating=parseInt(valueInput.value),date=dateInput.value,timestamp=date?Math.floor(new Date(date).getTime()/1e3):0,ratingKey=(null===(_editingDiv=editingDiv)||void 0===_editingDiv||null===(_editingDiv$dataset=_editingDiv.dataset)||void 0===_editingDiv$dataset?void 0:_editingDiv$dataset.key)||null;if(isNaN(rating)||rating<0||rating>5)alert("Please enter a rating between 0 and 5");else{var temppageurl=pageurl;pageurl.includes("book")&&!pageurl.includes("chapterid")&&(temppageurl+="&chapterid=".concat(params.chapterid)),Ajax.call([{methodname:"block_revisionmanager_save_rating",args:{courseid:params.courseid,pageid:params.pageid,ratingvalue:rating,ratingdate:timestamp,pageurl:temppageurl,pagetitle:params.pagetitle,chapterid:params.chapterid||null,ratingkey:ratingKey},done:function(response){if(editingDiv)editingDiv.className="rating-square bg-rating-".concat(rating),editingDiv.textContent=rating,editingDiv.title="Date: ".concat(date),editingDiv.dataset.rating=rating,editingDiv.dataset.date=date;else{const div=createRatingSquare(rating,date,response.ratingkey);grid.insertBefore(div,plusBtn)}popup.style.display="none",setTimeout((()=>{location.reload()}),300)},fail:Notification.exception}]),location.reload()}})),document.addEventListener("click",(e=>{popup.contains(e.target)||e.target===plusBtn||(popup.style.display="none")})),Ajax.call([{methodname:"block_revisionmanager_get_ratings",args:{courseid:params.courseid,pageid:params.pageid,chapterid:params.chapterid||null},done:function(ratings){ratings.forEach((r=>{const dateStr=new Date(1e3*r.ratingdate).toISOString().split("T")[0],div=createRatingSquare(r.ratingvalue,dateStr,r.ratingkey);grid.insertBefore(div,plusBtn)}))},fail:Notification.exception}]),$("#nextReview").on("input change",(function(){var date=$("#nextReview").val();date||(date=""),Ajax.call([{methodname:"block_revisionmanager_save_nextreview",args:{pageid:params.pageid,courseid:params.courseid,nextreview:date,pageurl:pageurl,chapterid:params.chapterid||null},done:function(response){console.log("next review date tweaked:",response.status)},fail:Notification.exception}])})),Ajax.call([{methodname:"block_revisionmanager_get_nextreview",args:{pageid:params.pageid,courseid:params.courseid,chapterid:params.chapterid||null},done:function(data){data.nextreview&&$("#nextReview").val(data.nextreview)},fail:Notification.exception}])}}}));

//# sourceMappingURL=databasecommunicator.min.js.map